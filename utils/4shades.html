<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>4shades ‚Äì Super luminous gb palettes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Neutral grey UI */
    /* Ensure preview canvases use nearest-neighbor rendering when upscaled */
    .preview-area canvas {
      /* Nearest-neighbor scaling for crisp pixel art */
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      image-rendering: -o-pixelated;
      -ms-interpolation-mode: nearest-neighbor;
    }
    /* Fade transition for palette previews */
    /* Fade transition for palette previews */
    .preview-area {
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
    }
    .preview-area.show {
      opacity: 1;
      max-height: 400px; /* enough to contain the scaled canvas */
    }
    /* Upload icon overlay on preview */
    .preview-area { position: relative; }
    .preview-area .upload-icon {
      position: absolute;
      left: 8px;
      bottom: 8px;
      width: 1.2em;
      height: 1.2em;
      fill: currentColor;
      opacity: 0;
      transition: opacity 0.2s;
      color: inherit;
    }
    .preview-area:hover .upload-icon { opacity: 1; }
    /* Rest of styles */
    body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: #eee; color: #333; margin: 20px; padding: 0; transition: background 0.3s, color 0.3s; }
    .container { max-width: 800px; margin: 0 auto; }
    .page-header { text-align: center; margin-bottom: 20px; }
    .page-header h1 { font-size: 3em; margin: 0; }
    .page-header .subtitle { font-size: 1em; color: #666; margin: 4px 0 0; }

    #tag-filter-container { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; margin-bottom: 20px; padding: 10px; background: #ccc; border: 1px solid #888; border-radius: 4px; }
    #tag-filter, #primary-sort, #secondary-sort, #sort-direction {
      margin: 4px 8px;
      padding: 6px 8px;
      font-size: 1em;
      background: #bbb;
      border: 1px solid #888;
      border-radius: 4px;
      color: #333;
      transition: background 0.3s, border 0.3s, color 0.3s;
    }
    .palette-container { position: relative; background: #ccc; border: 1px solid #888; border-radius: 4px; padding: 40px 20px 20px; margin-bottom: 60px; }
    .palette-reset, .palette-copy, .palette-preview {
      /* default: 25% transparent, fully grayscale */
      opacity: 0.25;
      filter: grayscale(100%);
      position: absolute;
      right: 10px;
      width: 40px;
      height: 32px;
      text-align: center;
      background: none;
      border: none;
      padding: 0;
      font-size: 1.5em;
      line-height: 32px;
      cursor: pointer;
      transition: opacity 0.2s, filter 0.2s, transform 0.1s;
      z-index: 10;
     }
    /* Preview button positioned bottom-left */
    .palette-preview {
      left: 10px;
      right: auto;
      bottom: 10px;
    }
    .palette-reset { top: 10px; }
    .palette-copy {
      bottom: 10px;
      top: auto;
    }
    .palette-reset:hover, .palette-copy:hover, .palette-preview:hover {
      /* on-hover: full opacity, reduced grayscale */
      opacity: 1;
      filter: grayscale(50%);
    }
    .visual-line-container { position: relative; width: 50%; height: 10px; margin: 20px auto; background: linear-gradient(90deg, #fff, #000); border-radius: 5px; box-shadow: inset 0 0 0 1px #888; overflow: visible; }
    .visual-line-label { position: absolute; top:50%; transform: translateY(-50%); font-size:0.8em; font-weight:bold; color:#555; }
    .visual-line-label.left { left:0; transform: translate(calc(-100% - 5px), -50%); }
    .visual-line-label.right { left:100%; transform: translate(5px, -50%); }
    .marker { position:absolute; bottom:5px; transform:translateX(-50%); cursor:grab; overflow:visible; }
    .marker:active { cursor:grabbing; }
    .marker-path { fill-rule:evenodd; stroke:#888; stroke-width:1px; }
    .l-value { position:absolute; bottom:-20px; transform:translateX(-50%); font-size:0.8em; color:#333; pointer-events:none; }
    .palette-details {
      text-align: center;
      margin-top: 30px; /* original spacing */
    }
    .palette-name {
      margin: 0; /* remove default h2 spacing */
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }
    /* Palette name links: inherit color and remove underline */
    .palette-name a {
      text-decoration: none;
      color: inherit;
    }
    .link-icon { margin-left:8px; text-decoration:none; font-size:1.1em; color:#333; }
    .palette-tags { margin-top:10px; font-style:italic; color:#555; }
    /* Dark mode overrides via class */
    body.dark-mode { background: #1e1e1e; color: #e0e0e0; }
    body.dark-mode .container { max-width: 800px; margin: 0 auto; }
    body.dark-mode #tag-filter-container { background: #2e2e2e; border-color: #555; }
    body.dark-mode #tag-filter-container label { color: #e0e0e0; }
    body.dark-mode #tag-filter, body.dark-mode #primary-sort, body.dark-mode #secondary-sort, body.dark-mode #sort-direction { background: #3a3a3a; border-color: #555; color: #e0e0e0; }
    body.dark-mode .palette-container { background: #2e2e2e; border-color: #555; }
    body.dark-mode .palette-reset, body.dark-mode .palette-copy, body.dark-mode .palette-preview {
      background: none;
      border: none;
      color: #e0e0e0;
    }
    body.dark-mode .palette-reset:hover, body.dark-mode .palette-copy:hover, body.dark-mode .palette-preview:hover {
      background: none;
    }
    body.dark-mode .visual-line-container { box-shadow: inset 0 0 0 1px #555; }
    body.dark-mode .marker-path { stroke: #888; }
    body.dark-mode .visual-line-label, body.dark-mode .palette-tags { color: #ccc; }
    body.dark-mode .l-value { color: #fff; }
    body.dark-mode .palette-name { color: #bbb; }
    body.dark-mode .link-icon { color: #e0e0e0; }
    /* Grayscale filter applied purely by CSS */
    body.no-chroma .visual-line-container,
    body.no-chroma .marker,
    body.no-chroma .preview-area canvas {
      filter: grayscale(100%);
    }
    @media (max-width:600px) { .visual-line-container { width:90%; } }
    /* Override link underline removal */
    .palette-name { text-decoration: none; }
    /* Reduce author font size */    /* Light mode button overrides (transparent) */
    body.light-mode .palette-reset, body.light-mode .palette-copy {
      background: none;
      border: none;
    }
    body.light-mode .palette-reset:hover, body.light-mode .palette-copy:hover {
      background: none;
    }
      /* Press feedback: depress buttons by moving 5px */
    .palette-reset:active, .palette-copy:active, .palette-preview:active {
      transform: translate(2px, 2px);
    }
  </style>
</head>
<body class="system-mode">
  <div id="dark-mode-toggle" title="Toggle theme" style="position:fixed;top:20px;right:20px;cursor:pointer;font-size:1.5em;z-index:1000;">üñ•Ô∏è</div>
  <div id="chroma-toggle" title="Switch to greyscale" style="position:fixed;top:20px;right:60px;cursor:pointer;font-size:1.5em;z-index:1000;">üé®</div>
  <div class="container">
    <div class="page-header">
      <h1>4shades</h1>
      <div class="subtitle">Super luminous gb palettes¬†‚Äì by aced</div>
      <p class="description">Visualize the perceptual luminance (L*) of 4‚Äëtone Game¬†Boy palettes. Tweak color values by dragging the markers.</p>
    </div>
    <div id="tag-filter-container">
      <label for="tag-filter">Filter:</label>
      <select id="tag-filter"></select>
      <label for="primary-sort">Sort by:</label>
      <select id="primary-sort">
        <option value="title">Name</option>
        <option value="0">Col¬†0</option>
        <option value="1">Col¬†1</option>
        <option value="2">Col¬†2</option>
        <option value="3">Col¬†3</option>
      </select>
      <label for="secondary-sort">Then by:</label>
      <select id="secondary-sort">
        <option value="">(none)</option>
      </select>
      <label for="sort-direction">Order:</label>
      <select id="sort-direction">
        <option value="asc">Ascending</option>
        <option value="desc">Descending</option>
      </select>

    </div>
    <div id="palette-container"></div>
  </div>
  <script>
    // Theme toggler
    const modes=['system','light','dark'], toggle=document.getElementById('dark-mode-toggle');let mi=0;
    function applyTheme() {
      const theme = modes[mi];
      if (theme === 'system') {
        const dark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.body.classList.toggle('dark-mode', dark);
        document.body.classList.toggle('light-mode', !dark);
      } else {
        document.body.classList.toggle('dark-mode', theme === 'dark');
        document.body.classList.toggle('light-mode', theme === 'light');
      }
      // update toggle icon
      toggle.textContent = theme === 'system' ? 'üñ•Ô∏è' : theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
    }
    toggle.onclick = () => { mi = (mi + 1) % 3; applyTheme(); };
    applyTheme();
    // Chroma display toggle via emoji
    // Will initialize in DOMContentLoaded
    // Remove global chromaToggle initialization to avoid duplication

    // State
    let selectedTag='all', dragData=null;
    // throttle flag for live preview
    let needsRemap = false;
    // Shared image preview variables
    let globalFileInput;
    let imgSelected = new Image();
    let imgBuffer = imgSelected;

    // Color conversions
    function hexToRgb(h){h=h.replace('#','');return{r:parseInt(h.substr(0,2),16),g:parseInt(h.substr(2,2),16),b:parseInt(h.substr(4,2),16)}}
    function rgbToXyz(r,g,b){const lin=x=>x/255<=0.04045?x/255/12.92:Math.pow((x/255+0.055)/1.055,2.4);const R=lin(r),G=lin(g),B=lin(b);return[(R*0.4124564+G*0.3575761+B*0.1804375)*100,(R*0.2126729+G*0.7151522+B*0.0721750)*100,(R*0.0193339+G*0.1191920+B*0.9503041)*100];}
    function xyzToLab(X,Y,Z){const ref=[95.047,100,108.883],f=(v,i)=>v/ref[i]>0.008856?Math.cbrt(v/ref[i]):7.787*(v/ref[i])+16/116;const x=f(X,0),y=f(Y,1),z=f(Z,2);return[116*y-16,500*(x-y),200*(y-z)];}
    function labToXyz(L,a,b){const y=(L+16)/116,x=a/500+y,z=y-b/200;const arr=[x*x*x,y*y*y,z*z*z];return[95.047*(arr[0]>0.008856?arr[0]:(x-16/116)/7.787),100*(arr[1]>0.008856?arr[1]:(y-16/116)/7.787),108.883*(arr[2]>0.008856?arr[2]:(z-16/116)/7.787)];}
    function xyzToRgb(X,Y,Z){X/=100;Y/=100;Z/=100;let r=X*3.2406+Y*-1.5372+Z*-0.4986,g=X*-0.9689+Y*1.8758+Z*0.0415,b=X*0.0557+Y*-0.2040+Z*1.0570;const conv=v=>v<=0.0031308?12.92*v:1.055*Math.pow(v,1/2.4)-0.055;return{r:Math.round(Math.min(Math.max(conv(r),0),1)*255),g:Math.round(Math.min(Math.max(conv(g),0),1)*255),b:Math.round(Math.min(Math.max(conv(b),0),1)*255)}}
    function labToRgb(L,a,b){return xyzToRgb(...labToXyz(L,a,b));}
    function rgbToHsv(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b),d=max-min;let h=0;if(d){if(max===r)h=((g-b)/d+(g<b?6:0));else if(max===g)h=((b-r)/d+2);else h=((r-g)/d+4);h=(h*60)%360;}const s=max?Math.round((d/max)*100):0,v=Math.round(max*100);return{h:Math.round(h),s,v};}
    function rgbToHex(r,g,b){const t=v=>v.toString(16).padStart(2,'0').toLowerCase();return `#${t(r)}${t(g)}${t(b)}`;}

    // Remap a single canvas to a 4-tone palette based on its markers (0=light ‚Üí 3=dark)
    function remapCanvas(ctx, w, h, markers) {
      // Pre-flatten and invert palette: bucket 0 maps to markers[3], 1‚Üí2, 2‚Üí1, 3‚Üí0
      const flat = [];
      for (let j = markers.length - 1; j >= 0; j--) {
        const { r, g, b } = hexToRgb(markers[j].__hex);
        flat.push(r, g, b);
      }

      // Perform posterization by using red-channel bucket and flat palette
      const imgData = ctx.getImageData(0, 0, w, h);
      const data = imgData.data;
      for (let i = 0; i < data.length; i += 4) {
        // bucket from red channel (0..3)
        const bucket = data[i] >> 6;
        // direct lookup: flat[ bucket*3 + 0..2 ]
        const base = bucket * 3;
        data[i]   = flat[base];
        data[i+1] = flat[base+1];
        data[i+2] = flat[base+2];
      }
      ctx.putImageData(imgData, 0, 0);
    }
    // Re-render all open previews after any change
    function remapAllPreviews() {
      document.querySelectorAll('.preview-area canvas').forEach(cv => {
        const w = cv.width, h = cv.height;
        const ctx = cv.getContext('2d');
        // redraw without resizing canvas
        ctx.clearRect(0,0,w,h);
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(imgBuffer, 0, 0, w, h);
        const markers = cv.closest('.palette-container').querySelectorAll('.marker');
        remapCanvas(ctx, w, h, markers);
      });
    }

    // Render functions
    function renderTagFilter() {
      const sel = document.getElementById('tag-filter');
      sel.innerHTML = '';
      sel.append(new Option('All', 'all'));
      const data = JSON.parse(document.getElementById('palettes-data').textContent);
      const tags = new Set();
      // emoji order for sorting and display
      const emojiOrder = ['üíõ','üíö','ü©µ','üíô','üíú','ü©∑','‚ù§Ô∏è','üß°','ü§é','üñ§','ü©∂','ü§ç','üåà'];
      data.forEach(p => p.tags && p.tags.forEach(t => tags.add(t.toLowerCase())));
      // Populate filter, '@'-tags without hash
      [...tags].sort((a, b) => {
        const ia = emojiOrder.indexOf(a), ib = emojiOrder.indexOf(b);
        if (ia !== -1 || ib !== -1) {
          if (ia !== -1 && ib !== -1) return ia - ib;
          return ia !== -1 ? -1 : 1;
        }
        return a.localeCompare(b);
      }).forEach(t => {
        const label = (emojiOrder.includes(t) || t.startsWith('@')) ? t : '#' + t;
        sel.append(new Option(label, t));
      });
      sel.onchange = () => { selectedTag = sel.value; renderPalettes(); };
    }
    function createMarkerSvg(hex,i){const{r,g,b}=hexToRgb(hex);const[L,a,bv]=xyzToLab(...rgbToXyz(r,g,b));const hsv0=rgbToHsv(r,g,b);const ns='http://www.w3.org/2000/svg';const svg=document.createElementNS(ns,'svg');
      svg.setAttribute('width','40');
      svg.setAttribute('height','60');svg.classList.add('marker');svg.setAttribute('viewBox','0 0 40 60');svg.style.overflow='visible';const title=document.createElementNS(ns,'title');const C=Math.hypot(a,bv).toFixed(1),hDeg=Math.round((Math.atan2(bv,a)*180/Math.PI+360)%360);title.textContent=`${hex}\nrgb(${r}, ${g}, ${b})\nhsb(${hsv0.h}¬∞, ${hsv0.s}%, ${hsv0.v}%)\nL*C*h_ab(${L.toFixed(1)}, ${C}, ${hDeg}¬∞)`;svg.append(title);const path=document.createElementNS(ns,'path');path.setAttribute('d','M6,0 H34 A6,6 0 0 1 40,6 V26 Q40,32 28,46 L20,60 L12,46 Q0,32 0,26 V6 A6,6 0 0 1 6,0 Z');path.setAttribute('fill', hex);path.classList.add('marker-path');svg.append(path);const txt=document.createElementNS(ns,'text');txt.setAttribute('x','20');txt.setAttribute('y','14');txt.setAttribute('text-anchor','middle');txt.setAttribute('fill','#fff');txt.setAttribute('font-size','14');txt.setAttribute('dy','.35em');txt.textContent=i;svg.append(txt);// Position marker according to reversed L* axis (100‚Üí0)
      svg.style.left = (100 - L) + '%';svg.__labAB={a,b: bv};svg.__origL=L;svg.__hex = hex;
      svg.__origHex = hex;return svg;}
    function renderPalette(p){const box=document.createElement('div');box.className='palette-container';const resetBtn=document.createElement('button');resetBtn.className='palette-reset';// Font Awesome 'arrow-rotate-left' icon
      resetBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="1em" height="1em">
          <path fill="currentColor" d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"/>
        </svg>
      `;
      resetBtn.title = 'Reset palette';
      resetBtn.onclick = () => {
        // Reset all markers to their original L* positions on reversed axis
        box.querySelectorAll('.marker').forEach(m => {
          const origL = m.__origL;
          m.style.left = (100 - origL) + '%';
          // revert hex to original
          m.__hex = m.__origHex;
          const { a, b } = m.__labAB;
          const rgb = labToRgb(origL, a, b);
          const path = m.querySelector('.marker-path');
          if (path) path.setAttribute('fill', `rgb(${rgb.r},${rgb.g},${rgb.b})`);
          // update tooltip
          const titleElem = m.querySelector('title');
          if (titleElem) {
            const hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
            const Cval = Math.hypot(a, b).toFixed(1);
            const hDeg = Math.round((Math.atan2(b, a) * 180/Math.PI + 360) % 360);
            titleElem.textContent =
              `${m.__hex}
rgb(${rgb.r}, ${rgb.g}, ${rgb.b})
hsb(${hsv.h}¬∞, ${hsv.s}%, ${hsv.v}% )
L*C*h_ab(${origL.toFixed(1)}, ${Cval}, ${hDeg}¬∞)`;
          }
        });
        // If a preview canvas exists but no image loaded, redraw placeholder
        const area = box.querySelector('.preview-area');
        if (area && !imgSelected.src) {
          const cv = area.querySelector('canvas');
          if (cv) {
            const ctx = cv.getContext('2d');
            const w = cv.width, h = cv.height;
            ctx.fillStyle = '#999'; ctx.fillRect(0, 0, w, h);
            ctx.fillStyle = '#666'; ctx.font = '14px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText('Select image', w / 2, h / 2);
          }
        }

        // Update any open previews with the reset palette
        remapAllPreviews();
    }; // close onclick callback
      box.append(resetBtn);const copyBtn = document.createElement('button');
      copyBtn.className = 'palette-copy';
      // Font Awesome 'copy' icon
      copyBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="1em" height="1em">
          <path fill="currentColor" d="M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z"/>
        </svg>
      `;
      copyBtn.title = 'Copy palette';
      copyBtn.title = 'Copy palette';
      copyBtn.onclick = () => {
        // Build GIMP GPL snippet
        let name = p.title.trim();
        let modified = false;
        const markers = box.querySelectorAll('.marker');
        markers.forEach((m, i) => {
          if (m.__hex.toUpperCase() !== p.colors[i].toUpperCase()) modified = true;
        });
        if (modified) {
          // ISO date YYYY-MM-DD
          const today = new Date().toISOString().split('T')[0];
          name += ` (modified ${today})`;
        }
        const lines = [];
        lines.push('GIMP Palette');
        lines.push(`Name: ${name}`);
        // Add origin as comment
        if (p.origin) lines.push(`# Origin: ${p.origin.trim()}`);
        if (p.source) lines.push(`# Source: ${p.source}`);
        markers.forEach((m, i) => {
          // export hex without '#' and in lowercase
          const hex = m.__hex.replace('#', '').toLowerCase();
          const { r, g, b } = hexToRgb(hex);
            lines.push(`${r}\t${g}\t${b}\tCol${i}-${hex}`);
        });
        navigator.clipboard.writeText(lines.join('\n'));
      };
      box.append(copyBtn);
      // preview button for image mapping
      const previewBtn = document.createElement('button');
      previewBtn.className = 'palette-preview';
      // Font Awesome 'image' icon
      previewBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="1em" height="1em">
          <path fill="currentColor" d="M0 96C0 60.7 28.7 32 64 32l384 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4s12.4 13.6 21.6 13.6l96 0 32 0 208 0c8.9 0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192a48 48 0 1 0 0-96 48 48 0 1 0 0 96z"/>
        </svg>
      `;
      previewBtn.title = 'Preview image';
      previewBtn.onclick = () => {
        // Toggle this palette's preview
        const existing = box.querySelector('.preview-area');
        if (existing) {
          existing.classList.remove('show');
          setTimeout(() => existing.remove(), 300);
          return;
        }
        // Create preview area
        const area = document.createElement('div');
        area.className = 'preview-area';
        const cv = document.createElement('canvas');
        // Determine size with auto-scaling
        let w, h;
        if (imgBuffer && (imgBuffer.width || imgBuffer.naturalWidth)) {
          const bufW = imgBuffer.width || imgBuffer.naturalWidth;
          const bufH = imgBuffer.height || imgBuffer.naturalHeight;
          if (bufW > 600 || bufH > 600) {
            // downscale large images by 50%
            w = Math.round(bufW / 2);
            h = Math.round(bufH / 2);
          } else if (bufW < 200 || bufH < 200) {
            // upscale small images by 2x
            w = bufW * 2;
            h = bufH * 2;
          } else {
            // use native size
            w = bufW;
            h = bufH;
          }
        } else {
          // default placeholder size
          w = 160;
          h = 144;
        }
        cv.width = w;
        cv.height = h;
        cv.height = h;
        cv.style.width = w + 'px';
        cv.style.height = h + 'px';
        cv.style.display = 'block';
        cv.style.margin = '10px auto';
        const ctx = cv.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        if (imgBuffer && (imgBuffer.src || imgBuffer.getContext)) {
          // Draw and remap
          ctx.drawImage(imgBuffer, 0, 0, w, h);
          const markers = box.querySelectorAll('.marker');
          remapCanvas(ctx, w, h, markers);
        } else {
          // Placeholder
          ctx.fillStyle = '#999'; ctx.fillRect(0, 0, w, h);
          ctx.fillStyle = '#666'; ctx.font = '14px sans-serif'; ctx.textAlign = 'center';
          ctx.fillText('Select image', w / 2, h / 2);
        }
        cv.style.cursor = 'pointer';
        cv.onclick = () => globalFileInput.click();
        // tooltip for selecting new image
        cv.title = 'Click to select a new image';
        area.append(cv);
        box.append(area);
        requestAnimationFrame(() => area.classList.add('show'));
      };
      box.append(previewBtn);const line=document.createElement('div');line.className='visual-line-container';const l0 = document.createElement('div');
      l0.className = 'visual-line-label left';
      l0.innerHTML = '<i>L</i>*';
      line.append(l0);p.colors.forEach((hex,i)=>{const m=createMarkerSvg(hex,i);line.append(m);const dot=document.createElement('div');dot.style.width='12px';dot.style.height='12px';dot.style.borderRadius='50%';dot.style.position='absolute';dot.style.bottom='calc(50% - 6px)';dot.style.transform='translateX(-50%)';// Position original dot on reversed axis
      dot.style.left = (100 - m.__origL) + '%';dot.style.background=hex;dot.style.border='1px solid #888';dot.title = `Reset ${i}`;
      dot.onclick = () => {
          const origL = m.__origL;
          // revert hex to original
          m.__hex = m.__origHex;
          // reposition marker on reversed axis
          m.style.left = (100 - origL) + '%';
          const { a, b } = m.__labAB;
          const rgb = labToRgb(origL, a, b);
          const path = m.querySelector('.marker-path');
          if (path) path.setAttribute('fill', `rgb(${rgb.r},${rgb.g},${rgb.b})`);
          // update tooltip
          const titleElem = m.querySelector('title');

      // Live-update preview on drag
      const previewCv = m.closest('.palette-container').querySelector('.preview-area canvas');
      if (previewCv) {
        const pw = previewCv.width, ph = previewCv.height;
        const pctx = previewCv.getContext('2d');
        pctx.clearRect(0, 0, pw, ph);
        pctx.imageSmoothingEnabled = false;
        pctx.drawImage(imgBuffer, 0, 0, pw, ph);
        const id2 = pctx.getImageData(0, 0, pw, ph);
        const d2 = id2.data;
        const marks = m.closest('.palette-container').querySelectorAll('.marker');
        for (let k = 0; k < d2.length; k += 4) {
          const avg2 = (d2[k] + d2[k+1] + d2[k+2]) / 3;
          const bucket2 = Math.min(3, Math.floor(avg2 / 64));
          const inv2 = 3 - bucket2;
          const hex2 = marks[inv2].__hex;
          const col2 = hexToRgb(hex2);
          d2[k] = col2.r;
          d2[k+1] = col2.g;
          d2[k+2] = col2.b;
        }
        pctx.putImageData(id2, 0, 0);
      }
        };line.append(dot);});box.append(line);const d=document.createElement('div');d.className='palette-details';// palette title as a header with link and id for deep linking
      const nm = document.createElement('h2');
      nm.className = 'palette-name';
      // generate slug id from paletteName
      const slug = p.title.trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
      nm.id = slug;
      if (p.source) {
        const link = document.createElement('a');
        link.href = p.source;
        link.target = '_blank';
        link.textContent = p.title;
        nm.append(link);
      } else {
        nm.textContent = p.title;
      }
      d.append(nm);
      // author subheading
      if (p.origin) {
        const auth = document.createElement('div');
        auth.className = 'palette-author';
        auth.textContent = 'by ' + p.origin.trim();
        d.append(auth);
      }if (p.tags) {
        const tg = document.createElement('div');
        tg.className = 'palette-tags';
        // clickable tags
        p.tags.forEach(tRaw => {
          const tag = tRaw.toLowerCase();
          const display = tRaw.startsWith('@') ? tRaw : '#' + tag;
          const span = document.createElement('span');
          span.textContent = display;
          span.style.cursor = 'pointer';
          span.style.margin = '0 4px';
          span.onclick = () => {
            selectedTag = tag;
            const sel = document.getElementById('tag-filter');
            sel.value = tag;
            renderPalettes();
          };
          tg.append(span);
        });
        d.append(tg);
      }
      box.append(d);
      return box;}
    function renderPalettes() {
      // Read sort/filter values
      const primary = document.getElementById('primary-sort').value;
      const secondarySelect = document.getElementById('secondary-sort');
      let secondary = secondarySelect.value;
      const direction = document.getElementById('sort-direction').value;

      // Adjust secondary options
      if (primary === 'title') {
        secondarySelect.innerHTML = '<option value="">(none)</option>';
        secondarySelect.disabled = true;
        secondary = '';
      } else {
        secondarySelect.disabled = false;
        const prev = secondary;
        secondarySelect.innerHTML =
          '<option value="L">L*</option>' +
          '<option value="C">C*</option>' +
          '<option value="h">h*</option>';
        secondarySelect.value = ['L','C','h'].includes(prev) ? prev : 'L';
        secondary = secondarySelect.value;
      }

      // Load data
      let ps = JSON.parse(document.getElementById('palettes-data').textContent);

      // Sort palettes
      ps.sort((a, b) => {
        let cmp = 0;
        if (primary === 'title') {
          cmp = a.title.localeCompare(b.title);
        } else {
          const idx = parseInt(primary, 10);
          const rgbA = hexToRgb(a.colors[idx]);
          const rgbB = hexToRgb(b.colors[idx]);
          const [La, aA, bA] = xyzToLab(...rgbToXyz(rgbA.r, rgbA.g, rgbA.b));
          const [Lb, aB, bB] = xyzToLab(...rgbToXyz(rgbB.r, rgbB.g, rgbB.b));
          const metric = (L, aVal, bVal) => {
            if (secondary === 'C') return Math.hypot(aVal, bVal);
            if (secondary === 'h') return (Math.atan2(bVal, aVal) * 180/Math.PI + 360) % 360;
            return L;
          };
          cmp = metric(La, aA, bA) - metric(Lb, aB, bB);
        }
        return direction === 'desc' ? -cmp : cmp;
      });

      // Filter and render
      const container = document.getElementById('palette-container');
      container.innerHTML = '';
      ps.filter(p => selectedTag === 'all' || (p.tags && p.tags.map(t => t.toLowerCase()).includes(selectedTag)))
        .forEach(p => container.appendChild(renderPalette(p)));

      bindDrag();}
    function bindDrag(){document.querySelectorAll('.marker').forEach(m=>{m.onmousedown = e => {
        e.preventDefault();
        const startX = e.clientX;
        const startCoord = parseFloat(m.style.left);
        const startL = 100 - startCoord;  // convert to actual L* value
        const rect = m.parentElement.getBoundingClientRect();
        const lv = document.createElement('div');lv.className='l-value';m.parentElement.append(lv);dragData={m,startX,startL,rect,lv};document.onmousemove=doDrag;document.onmouseup=endDrag;};});}
    function doDrag(e) {
      if (!dragData) return;
      e.preventDefault();
      const { m, startX, startL, rect, lv } = dragData;
      const dx = e.clientX - startX;
      const newL = Math.min(100, Math.max(0, startL - (dx / rect.width) * 100));
      // Position marker on reversed axis
      m.style.left = (100 - newL) + '%';
      // Recalculate color
      const { a, b } = m.__labAB;
      const rgb = labToRgb(newL, a, b);
      const newHex = rgbToHex(rgb.r, rgb.g, rgb.b);
      m.__hex = newHex;
      // Update marker fill
      const path = m.querySelector('.marker-path');
      if (path) path.setAttribute('fill', `rgb(${rgb.r},${rgb.g},${rgb.b})`);
      // Update live label
      lv.textContent = Math.round(newL) + '%';
      lv.style.left = (100 - newL) + '%';
      // Update tooltip
      const titleElem = m.querySelector('title');
      if (titleElem) {
        const hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
        const Cval = Math.hypot(a, b).toFixed(1);
        const hDeg = Math.round((Math.atan2(b, a) * 180/Math.PI + 360) % 360);
        titleElem.textContent =
          `${newHex}
rgb(${rgb.r}, ${rgb.g}, ${rgb.b})
hsb(${hsv.h}¬∞, ${hsv.s}%, ${hsv.v}%)
L*C*h_ab(${newL.toFixed(1)}, ${Cval}, ${hDeg}¬∞)`;
      }
      // Schedule live preview update
      needsRemap = true;
      // immediate fallback to ensure preview updates
      remapAllPreviews();
    }

    function endDrag() {
      if (dragData && dragData.lv) {
        dragData.lv.remove();
      }
      document.onmousemove = null;
      document.onmouseup = null;
      dragData = null;
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Global image selector for all palette previews
      globalFileInput = document.createElement('input');
      globalFileInput.type = 'file';
      globalFileInput.accept = 'image/*';
      globalFileInput.style.display = 'none';
        imgSelected = new Image();
      globalFileInput.onchange = () => {
        const file = globalFileInput.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        imgSelected.onload = () => {
          // update buffer to loaded image
          imgBuffer = imgSelected;
          // resize existing preview canvases to match new image dimensions
          document.querySelectorAll('.preview-area canvas').forEach(cv => {
            const bufW = imgBuffer.width || imgBuffer.naturalWidth;
            const bufH = imgBuffer.height || imgBuffer.naturalHeight;
            let w, h;
            if (bufW > 600 || bufH > 600) {
              w = Math.round(bufW / 2);
              h = Math.round(bufH / 2);
            } else if (bufW < 200 || bufH < 200) {
              w = bufW * 2;
              h = bufH * 2;
            } else {
              w = bufW;
              h = bufH;
            }
            cv.width = w;
            cv.height = h;
            cv.style.width = w + 'px';
            cv.style.height = h + 'px';
          });
          // redraw all open previews with the new image
          remapAllPreviews();
          URL.revokeObjectURL(url);
        };
        imgSelected.src = url;
      };
      document.body.append(globalFileInput);

      // listen for system theme changes
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      mq.addEventListener('change', () => {
        if (modes[mi] === 'system') applyTheme();
      });
      renderTagFilter();
      ['primary-sort','secondary-sort','sort-direction'].forEach(id =>
        document.getElementById(id).addEventListener('change', renderPalettes)
      );
      // Chroma toggle: apply CSS class for grayscale
      const chromaToggle = document.getElementById('chroma-toggle');
      // initialize toggle state and icon
      const isNoInitial = document.body.classList.contains('no-chroma');
      chromaToggle.textContent = isNoInitial ? 'üé®' : 'ü©∂';
      chromaToggle.title = isNoInitial ? 'Display with color' : 'Display as grayscale';
      chromaToggle.onclick = () => {
        const isNo = document.body.classList.toggle('no-chroma');
        chromaToggle.textContent = isNo ? 'üé®' : 'ü©∂';
        chromaToggle.title = isNo ? 'Display with color' : 'Display as grayscale';
      };
      renderPalettes();
    });
  </script>
  <script type="application/json" id="palettes-data">
  [
    {"title":"Velvet Cherry GB","origin":"Klafooty","source":"https://lospec.com/palette-list/velvet-cherry-gb","colors": ["#9775a6","#683a68","#412752","#2d162c"],"tags":["Lospec","üíú"]},
    {"title":"Fiery Plague GB","origin":"Klafooty","source":"https://lospec.com/palette-list/fiery-plague-gb","colors":["#713141","#512839","#312137","#1a2129"],"tags":["Lospec","‚ù§Ô∏è","üíú"]},
    {"title":"Moon Crystal","origin":"Doph","source":"https://lospec.com/palette-list/moon-crystal","colors": ["#ffe2db","#d9a7c6","#8d89c7","#755f9c"],"tags":["Lospec","Soft", "üíú","ü©∑"]},
    {"title":"Optimized Grayscale 4","origin":"Yousurname","source":"https://lospec.com/palette-list/optimized-grayscale-4","colors": ["#dfdfdf","#9f9f9f","#606060","#202020"],"tags":["Lospec","Mono","ü©∂"]},
    {"title":"Absorbent and Yellow","origin":"TheWolfBunny64","source":"https://thewolfbunny64.itch.io/game-boy-custom-palettes","colors": ["#fff752","#aec600","#687600","#343b00"],"tags":["@thewolfbunny64","USA-Pop-Culture","üíõ"]},
    {"title":"Barbie Pink","origin":"TheWolfBunny64","source":"https://thewolfbunny64.itch.io/game-boy-custom-palettes","colors": ["#f200a1","#c10080","#790050","#480030"],"tags":["@thewolfbunny64","USA-Pop-Culture","ü©∑"]},
    {"title":"Bedrock Caveman Vision","origin":"TheWolfBunny64","source":"https://thewolfbunny64.itch.io/game-boy-custom-palettes","colors": ["#ff7f00","#009eb8","#005e6e","#002f37"],"tags":["@thewolfbunny64","USA-Pop-Culture","üåà"]}
    ]
  </script>
</body>
</html>
