<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>4shades - Super luminous gb palettes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
/* styles.css - reorganized for clarity, maintainability, and conciseness */

/* ========================================================================== */
/* Variables */
/* ========================================================================== */
:root {
  /* Colors */
  --bg-light:   #eee;
  --bg-dark:    #1e1e1e;
  --text-light: #333;
  --text-dark:  #e0e0e0;

  /* UI */
  --ui-bg:      #ccc;
  --ui-border:  #888;
  --ui-bg-dark: #3a3a3a;

  /* Layout */
  --max-width:      800px;
  --gutter:         20px;
  --gradient-width: 600px; /* Preferred max width for gradient */

  /* Timing */
  --trans:      0.3s ease-in-out;
  --trans-fast: 0.2s ease-in;
}

/* ========================================================================== */
/* Global Reset */
/* ========================================================================== */
*, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
button {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  -webkit-tap-highlight-color: transparent;
  background: none;
  border: none;
  color: inherit;
  outline: none;
}

/* ========================================================================== */
/* Toggle Buttons */
/* ========================================================================== */
#dark-mode-toggle, #chroma-toggle {
  position: fixed;
  top: 20px;
  cursor: pointer;
  font-size: 1.5rem;
  z-index: 1000;
}
#dark-mode-toggle { right: 20px; }
#chroma-toggle     { right: 60px; }

/* ========================================================================== */
/* Toast Notifications */
/* ========================================================================== */
.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(0,0,0,0.7);
  color: #fff;
  padding: 8px 12px;
  border-radius: 4px;
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
  z-index: 10000;
}
.toast.visible { opacity: 1; }

/* ========================================================================== */
/* Base Styles */
/* ========================================================================== */
body {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  background: var(--bg-light);
  color: var(--text-light);
  margin: var(--gutter);
  transition: background var(--trans), color var(--trans);
}
.container {
  max-width: var(--max-width);
  margin: 0 auto;
}

/* ========================================================================== */
/* Page Header */
/* ========================================================================== */
.page-header {
  text-align: center;
  margin-bottom: 20px;
}
.page-header h1 {
  font-size: 4rem;
  margin: 0;
}
.page-header .subtitle {
  font-size: 1rem;
  color: #666;
  margin: 4px 0 40px;
}
.page-header .description {
  margin: 0;
}

/* ========================================================================== */
/* Filter & Sort Controls */
/* ========================================================================== */
#tag-filter-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center; /* vertically center labels and selects */
  padding: 10px;
  gap: 4px;
  background: var(--ui-bg);
  border: 1px solid var(--ui-border);
  border-radius: 4px;
  margin-bottom: 20px;
}
#tag-filter-container label {
  font-size: 1rem;
  margin: 0 2px;
  color: inherit;
}
#tag-filter-container select {
  margin: 0 2px;
  padding: 6px 8px;
  font-size: 1rem;
  background: #bbb;
  border: 1px solid var(--ui-border);
  border-radius: 4px;
  color: var(--text-light);
  transition: background var(--trans), border var(--trans), color var(--trans);
}

/* ========================================================================== */
/* Palette Cards */
/* ========================================================================== */
.palette-container {
  position: relative;
  background: var(--ui-bg);
  border: 1px solid var(--ui-border);
  border-radius: 4px;
  padding: 3rem 1rem 1rem; /* increased top padding for extra space */
  margin-bottom: 3.75rem;
}
.palette-container button {
  opacity: 0.2;
  position: absolute;
  width: 40px;
  height: 32px;
  font-size: 1.5rem;
  line-height: 32px;
  cursor: pointer;
  transition: opacity var(--trans-fast), transform 0.1s;
}
.palette-container button:hover { opacity: 1; }
.palette-container button:active { transform: translate(2px, 2px); }
.palette-reset   { top: 0.625rem; right: 0.625rem; }
.palette-copy    { bottom: 0.625rem; right: 0.625rem; }
.palette-preview { bottom: 0.625rem; left:  0.625rem; }

/* Touch support: ensure active state */
.palette-reset.pressed,
.palette-copy.pressed,
.palette-preview.pressed {
  opacity: 1 !important;
  transform: translate(2px, 2px) !important;
}

/* ========================================================================== */
/* Preview Area */
/* ========================================================================== */
.preview-area {
  opacity: 0;
  max-height: 0;
  overflow: hidden;
  padding: 0;
  transition: opacity 0.25s ease-in-out,
              max-height 0.25s ease-in-out,
              padding 0.25s ease-in-out;
}
.preview-area.show {
  opacity: 1;
  max-height: 400px;
  padding: 0.625rem 0;
}
.preview-area canvas {
  display: block;
  margin: 0.625rem auto;
  image-rendering: pixelated;
  image-rendering: -moz-crisp-edges;
  image-rendering: crisp-edges;
  image-rendering: -o-pixelated;
  -ms-interpolation-mode: nearest-neighbor;
}

/* ========================================================================== */
/* Visual L* Gradient & Markers */
/* ========================================================================== */
.visual-line-container {
  position: relative;
  width: 100%;
  max-width: var(--gradient-width);
  margin: 1.25rem auto;
  height: 10px; /* restored original height */
  padding-top: 8px; /* added top padding for marker overflow */
  background: linear-gradient(90deg, #fff, #000);
  border-radius: 5px;
  box-shadow: inset 0 0 0 1px var(--ui-border);
  overflow: visible;
}
.visual-line-label {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.8em;
  font-weight: bold;
  color: #555;
}
.visual-line-label.left {
  left: 0;
  transform: translate(calc(-100% - 5px), -50%);
}
.marker {
  position: absolute;
  bottom: 5px;
  transform: translateX(-50%);
  cursor: grab;
  overflow: visible;
}
.marker:active { cursor: grabbing; }
.marker-path {
  fill-rule: evenodd;
  stroke: #888;
  stroke-width: 1px;
}
.l-value {
  position: absolute;
  bottom: -20px;
  transform: translateX(-50%);
  font-size: 0.8em;
  color: var(--text-light);
  pointer-events: none;
}

/* ========================================================================== */
/* Palette Details */
/* ========================================================================== */
.palette-details {
  text-align: center;
  margin-top: 1.875rem;
}
.palette-name {
  font-size: 1.2rem;
  font-weight: bold;
  text-decoration: none;
  color: var(--text-light);
  margin: 0;
}
.palette-name a {
  text-decoration: none;
  color: inherit;
}
.palette-author {
  font-size: 0.75rem;
  margin-top: 0.125rem;
}
.palette-tags {
  margin-top: 0.625rem;
  font-style: italic;
  color: #555;
}

/* ========================================================================== */
/* Dark Mode */
/* ========================================================================== */
body.dark-mode {
  background: var(--bg-dark);
  color: var(--text-dark);
}
body.dark-mode #tag-filter-container {
  background: #2e2e2e;
  border-color: #555;
}
body.dark-mode #tag-filter-container label {
  color: var(--text-dark);
}
body.dark-mode #tag-filter-container select {
  background: var(--ui-bg-dark);
  border-color: #555;
  color: var(--text-dark);
}
body.dark-mode .palette-container {
  background: #2e2e2e;
  border-color: #555;
}
body.dark-mode .palette-reset,
body.dark-mode .palette-copy,
body.dark-mode .palette-preview {
  color: var(--text-dark);
}
body.dark-mode .visual-line-container {
  box-shadow: inset 0 0 0 1px #555;
}
body.dark-mode .marker-path { stroke: #888; }
body.dark-mode .visual-line-label,
body.dark-mode .palette-tags { color: #ccc; }
body.dark-mode .l-value { color: #fff; }
body.dark-mode .palette-name { color: #bbb; }

/* ========================================================================== */
/* Grayscale Mode */
/* ========================================================================== */
body.no-chroma .visual-line-container,
body.no-chroma .marker,
body.no-chroma .preview-area canvas {
  filter: grayscale(100%);
}

/* ========================================================================== */
/* Responsive Adjustments */
/* ========================================================================== */
@media (max-width: 800px) {
  .visual-line-container {
    width: 85%;
    max-width: var(--gradient-width);
  }
  .palette-tags { font-size: 0.8rem; }
  #tag-filter-container {
    flex-direction: column;
    align-items: stretch;
  }
    #tag-filter-container label {
    width: 100%;
    margin: 6px 0 2px;
  }
  #tag-filter-container select {
    width: 100%;
    margin: 2px 0 10px;
  }
}

  </style>
</head>
<body class="system-mode">
  <div id="dark-mode-toggle" title="Toggle theme">üñ•Ô∏è</div>
  <div id="chroma-toggle" title="Switch to greyscale">üé®</div>
  <div class="container">
    <div class="page-header">
      <h1>4shades</h1>
      <div class="subtitle">Super luminous gb palettes¬†- by aced</div>
      <p class="description">Visualize the perceptual luminance (L*) of 4‚Äëtone Game¬†Boy palettes. Tweak color values by dragging the markers.</p>
    </div>
    <div id="tag-filter-container">
      <label for="tag-filter">Filter:</label>
      <select id="tag-filter"></select>
      <label for="primary-sort">Sort by:</label>
      <select id="primary-sort">
        <option value="title">Name</option>
        <option value="0">Color¬†0</option>
        <option value="1">Color¬†1</option>
        <option value="2">Color¬†2</option>
        <option value="3">Color¬†3</option>
      </select>
      <label for="secondary-sort">Then by:</label>
      <select id="secondary-sort">
        <option value="">(none)</option>
      </select>
      <label for="sort-direction">Order:</label>
      <select id="sort-direction">
        <option value="asc">Ascending</option>
        <option value="desc">Descending</option>
      </select>

    </div>
    <!-- Placeholder image for previews -->
<img id="gb-placeholder" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACQCAAAAACq3j9cAAACNUlEQVR4Ae3WhZLqShgE4Pu0nSFIcAkSgrOCRfttbw2H2eOnbH27sbG/6sP///jOI6CAAgoo4LuOgAIKKKCAAgoooIACCiiggAIKKKCAAgoooIACCiiggAIKKKCAAgoo4HG1Tvk92eGvB9M3AfYBg/qZLkvwlzxOeY03ewvgGuuSJxP8AxjfVg7JWwDHuFjmiDy3TbC+At2Qc98MjtsKGldaZ8NJOPGDh5nvL8lj39TDgry0/d6y54qeHbhDbXGyg9SrRH2sLdANYwznlcqxgzi/vcUdVCcGZhIgLX0/jhCzMP60DuOKnh3IyANMmHKMlGzVLdANTZvc4xSDdEAvZ4Q1j7jLWgeyFXCJE1k1ruj5geRhXkOtbHphGNY9C7wNM8xp8yMwIFfImGDLLB4ECDgyJEPjip4dON/Z+xGONTOwscDb8Iz1b8CWBZYWmHteLwoC9n2SkXFFzw4MavZ+jWPXI7mdW+BtWGBI3vvnPwNjHMkg4BQZ2TGu6NmBCwyO6d73iy3Cy9IbWaAbdr3loW64xGP5O3CLbRqhXh7QeYhgXNGzAzkB4LVO3wbNnCs8DdMG0Hjg2cP5CoyegCm2ZQDUpgi59FDpGFf0/EDmh0NJm+zx4tbcMEntfZHxT7kkZJqnD2XBUcsVvb9m4YLJaYP5O+5mYh8mfN/tVq6G9QMABRRQQAEFFFBAAQUUUEABBRRQQAEFFFBAAQUUUEABBRRQQAEFFFBAAQUUUEABBRRQQAEF/B8as4trcKGFpgAAAABJRU5ErkJggg==" alt="placeholder" style="display:none;" />
<div id="palette-container"></div>
  </div>
  <script>
    // Mobile fix for buttons
    document.body.addEventListener('touchstart', () => {}, {passive: true});

    // Toast helper
    function showToast(msg) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      // fade in
      requestAnimationFrame(() => t.classList.add('visible'));
      // fade out after 1.5s
      setTimeout(() => {
        t.classList.remove('visible');
        setTimeout(() => t.remove(), 300);
      }, 1500);
    }
    // Theme toggler
    const modes=['system','light','dark'], toggle=document.getElementById('dark-mode-toggle');let mi=0;
    function applyTheme() {
      const theme = modes[mi];
      if (theme === 'system') {
        const dark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.body.classList.toggle('dark-mode', dark);
        document.body.classList.toggle('light-mode', !dark);
      } else {
        document.body.classList.toggle('dark-mode', theme === 'dark');
        document.body.classList.toggle('light-mode', theme === 'light');
      }
      // update toggle icon
      toggle.textContent = theme === 'system' ? 'üñ•Ô∏è' : theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
    }
    toggle.onclick = () => { mi = (mi + 1) % 3; applyTheme(); };
    applyTheme();

    // Utility: slugify a string for IDs and filenames
    function slugify(text) {
      return text
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    // State
    let selectedTag='all', dragData=null;// Shared image preview variables
    let globalFileInput;
    let imgSelected = new Image();
    let imgBuffer = imgSelected;

    // Color conversions
    function hexToRgb(h){h=h.replace('#','');return{r:parseInt(h.substr(0,2),16),g:parseInt(h.substr(2,2),16),b:parseInt(h.substr(4,2),16)}}
    function rgbToXyz(r,g,b){const lin=x=>x/255<=0.04045?x/255/12.92:Math.pow((x/255+0.055)/1.055,2.4);const R=lin(r),G=lin(g),B=lin(b);return[(R*0.4124564+G*0.3575761+B*0.1804375)*100,(R*0.2126729+G*0.7151522+B*0.0721750)*100,(R*0.0193339+G*0.1191920+B*0.9503041)*100];}
    function xyzToLab(X,Y,Z){const ref=[95.047,100,108.883],f=(v,i)=>v/ref[i]>0.008856?Math.cbrt(v/ref[i]):7.787*(v/ref[i])+16/116;const x=f(X,0),y=f(Y,1),z=f(Z,2);return[116*y-16,500*(x-y),200*(y-z)];}
    function labToXyz(L,a,b){const y=(L+16)/116,x=a/500+y,z=y-b/200;const arr=[x*x*x,y*y*y,z*z*z];return[95.047*(arr[0]>0.008856?arr[0]:(x-16/116)/7.787),100*(arr[1]>0.008856?arr[1]:(y-16/116)/7.787),108.883*(arr[2]>0.008856?arr[2]:(z-16/116)/7.787)];}
    function xyzToRgb(X,Y,Z){X/=100;Y/=100;Z/=100;let r=X*3.2406+Y*-1.5372+Z*-0.4986,g=X*-0.9689+Y*1.8758+Z*0.0415,b=X*0.0557+Y*-0.2040+Z*1.0570;const conv=v=>v<=0.0031308?12.92*v:1.055*Math.pow(v,1/2.4)-0.055;return{r:Math.round(Math.min(Math.max(conv(r),0),1)*255),g:Math.round(Math.min(Math.max(conv(g),0),1)*255),b:Math.round(Math.min(Math.max(conv(b),0),1)*255)}}
    function labToRgb(L,a,b){return xyzToRgb(...labToXyz(L,a,b));}
    function rgbToHsv(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b),d=max-min;let h=0;if(d){if(max===r)h=((g-b)/d+(g<b?6:0));else if(max===g)h=((b-r)/d+2);else h=((r-g)/d+4);h=(h*60)%360;}const s=max?Math.round((d/max)*100):0,v=Math.round(max*100);return{h:Math.round(h),s,v};}
    function rgbToHex(r,g,b){const t=v=>v.toString(16).padStart(2,'0').toLowerCase();return `#${t(r)}${t(g)}${t(b)}`;}

    // Remap a single canvas to a 4-tone palette based on its markers (0=light ‚Üí 3=dark)
    function remapCanvas(ctx, w, h, markers) {
      // Pre-flatten and invert palette: bucket 0 maps to markers[3], 1‚Üí2, 2‚Üí1, 3‚Üí0
      const flat = [];
      for (let j = markers.length - 1; j >= 0; j--) {
        const { r, g, b } = hexToRgb(markers[j].__hex);
        flat.push(r, g, b);
      }

      // Perform posterization by using red-channel bucket and flat palette
      const imgData = ctx.getImageData(0, 0, w, h);
      const data = imgData.data;
      for (let i = 0; i < data.length; i += 4) {
        // bucket from red channel (0..3)
        const bucket = data[i] >> 6;
        // direct lookup: flat[ bucket*3 + 0..2 ]
        const base = bucket * 3;
        data[i]   = flat[base];
        data[i+1] = flat[base+1];
        data[i+2] = flat[base+2];
      }
      ctx.putImageData(imgData, 0, 0);
    }
    // Re-render all open previews after any change
    function remapAllPreviews() {
      document.querySelectorAll('.preview-area canvas').forEach(cv => {
        const w = cv.width, h = cv.height;
        const ctx = cv.getContext('2d', { willReadFrequently: true });
        // redraw without resizing canvas
        ctx.clearRect(0,0,w,h);
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(imgBuffer, 0, 0, w, h);
        const markers = cv.closest('.palette-container').querySelectorAll('.marker');
        remapCanvas(ctx, w, h, markers);
      });
    }

    // Button press state handling for pointer devices
    function bindButtonPressStates() {
      document.querySelectorAll('.palette-reset, .palette-copy, .palette-preview').forEach(btn => {
        // Pointer events
        btn.addEventListener('pointerdown', () => btn.classList.add('pressed'));
        btn.addEventListener('pointerup',   () => btn.classList.remove('pressed'));
        btn.addEventListener('pointercancel', () => btn.classList.remove('pressed'));
        // Touch events fallback for iOS
        btn.addEventListener('touchstart', () => btn.classList.add('pressed'));
        btn.addEventListener('touchend',   () => btn.classList.remove('pressed'));
        btn.addEventListener('touchcancel',() => btn.classList.remove('pressed'));
      });
    }

    // Render functions
    function renderTagFilter() {
      const sel = document.getElementById('tag-filter');
      sel.innerHTML = '';
      sel.append(new Option('All', 'all'));
      const data = JSON.parse(document.getElementById('palettes-data').textContent);
      const tags = new Set();
      // emoji order for sorting and display
      const emojiOrder = ['üíõ','üíö','ü©µ','üíô','üíú','ü©∑','‚ù§Ô∏è','üß°','ü§é','ü©∂','üåà'];
      data.forEach(p => p.tags && p.tags.forEach(t => tags.add(t.toLowerCase())));
      // Populate filter, '@'-tags without hash
      [...tags].sort((a, b) => {
        const ia = emojiOrder.indexOf(a), ib = emojiOrder.indexOf(b);
        if (ia !== -1 || ib !== -1) {
          if (ia !== -1 && ib !== -1) return ia - ib;
          return ia !== -1 ? -1 : 1;
        }
        return a.localeCompare(b);
      }).forEach(t => {
        const label = (emojiOrder.includes(t) || t.startsWith('@')) ? t : '#' + t;
        sel.append(new Option(label, t));
      });
      sel.onchange = () => { selectedTag = sel.value; renderPalettes();
      // Handle button press visual feedback
      bindButtonPressStates(); };
    }
    function createMarkerSvg(hex,i){const{r,g,b}=hexToRgb(hex);const[L,a,bv]=xyzToLab(...rgbToXyz(r,g,b));const hsv0=rgbToHsv(r,g,b);const ns='http://www.w3.org/2000/svg';const svg=document.createElementNS(ns,'svg');
      svg.setAttribute('width','40');
      svg.setAttribute('height','60');svg.classList.add('marker');svg.setAttribute('viewBox','0 0 40 60');svg.style.overflow='visible';const title=document.createElementNS(ns,'title');const C=Math.hypot(a,bv).toFixed(1),hDeg=Math.round((Math.atan2(bv,a)*180/Math.PI+360)%360);title.textContent=`${hex}\nrgb(${r}, ${g}, ${b})\nhsb(${hsv0.h}¬∞, ${hsv0.s}%, ${hsv0.v}%)\nL*C*h_ab(${L.toFixed(1)}, ${C}, ${hDeg}¬∞)`;svg.append(title);const path=document.createElementNS(ns,'path');path.setAttribute('d','M6,0 H34 A6,6 0 0 1 40,6 V26 Q40,32 28,46 L20,60 L12,46 Q0,32 0,26 V6 A6,6 0 0 1 6,0 Z');path.setAttribute('fill', hex);path.classList.add('marker-path');svg.append(path);const txt=document.createElementNS(ns,'text');txt.setAttribute('x','20');txt.setAttribute('y','14');txt.setAttribute('text-anchor','middle');txt.setAttribute('fill','#fff');txt.setAttribute('font-size','14');txt.setAttribute('dy','.35em');txt.textContent=i;svg.append(txt);// Position marker according to reversed L* axis (100‚Üí0)
      svg.style.left = (100 - L) + '%';svg.__labAB={a,b: bv};svg.__origL=L;svg.__hex = hex;
      svg.__origHex = hex;return svg;}
    function renderPalette(p){const box=document.createElement('div');box.className='palette-container';const resetBtn=document.createElement('button');resetBtn.className='palette-reset';// Feather `rotate-ccw`
      resetBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13 -9.36L1 10"/></svg>`;
      resetBtn.title = 'Reset palette';
      resetBtn.onclick = () => {
        // Reset all markers to their original L* positions on reversed axis
        box.querySelectorAll('.marker').forEach(m => {
          const origL = m.__origL;
          m.style.left = (100 - origL) + '%';
          // revert hex to original
          m.__hex = m.__origHex;
          const { a, b } = m.__labAB;
          const rgb = labToRgb(origL, a, b);
          const path = m.querySelector('.marker-path');
          if (path) path.setAttribute('fill', `rgb(${rgb.r},${rgb.g},${rgb.b})`);
          // update tooltip
          const titleElem = m.querySelector('title');
          if (titleElem) {
            const hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
            const Cval = Math.hypot(a, b).toFixed(1);
            const hDeg = Math.round((Math.atan2(b, a) * 180/Math.PI + 360) % 360);
            titleElem.textContent =
              `${m.__hex}
rgb(${rgb.r}, ${rgb.g}, ${rgb.b})
hsb(${hsv.h}¬∞, ${hsv.s}%, ${hsv.v}% )
L*C*h_ab(${origL.toFixed(1)}, ${Cval}, ${hDeg}¬∞)`;
          }
        });
        // Update any open previews with the reset palette
        remapAllPreviews();

        // Safari active-state workaround
        resetBtn.disabled = true; resetBtn.blur(); resetBtn.disabled = false;
      }; // close onclick callback
      box.append(resetBtn);const copyBtn = document.createElement('button');
      copyBtn.className = 'palette-copy';
      // Feather 'copy'
      copyBtn.innerHTML = `
       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" stroke="currentColor" fill="none" stroke-width="2.5" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
      `;
      copyBtn.title = 'Copy palette to clipboard';
      copyBtn.onclick = () => {
        // Build GIMP GPL snippet
        let name = p.title.trim();
        let isModified = false;
        // Prepare lines array before use
        const lines = [];
        lines.push('GIMP Palette');
        lines.push(`Name: ${name}`);
        if (p.origin) lines.push(`# Origin: ${p.origin.trim()}`);
        if (p.source) lines.push(`# Source: ${p.source}`);

        // Check markers for modifications and build color lines
        const markers = box.querySelectorAll('.marker');
        markers.forEach((m, i) => {
          // Detect if any marker differs from original JSON
          if (m.__hex.toUpperCase() !== p.colors[i].toUpperCase()) {
            isModified = true;
          }
          // Determine suffix for this color
          const suffix = m.__hex.toLowerCase() !== m.__origHex.toLowerCase() ? '*' : '';
          // Build color line
          const hex = m.__hex.replace('#', '').toLowerCase();
          const { r, g, b } = hexToRgb(hex);
          lines.push(`${r}\t${g}\t${b}\tColor${i}-${hex}${suffix}`);
        });

        // Append modified flag to name if needed
        if (isModified) {
          const today = new Date().toISOString().split('T')[0];
          // Update the Name line
          lines[1] = `Name: ${name} (* modified ${today})`;
        }

        // Append ImageMagick export snippet for bash
        const cols = Array.from(markers).map(m => m.__hex.toLowerCase());
        lines.push('\n# magick in.png \\');
        lines.push(
          `#   -colorspace RGB -fill '${cols[0]}' -opaque white -fuzz 15% ` +
          `-fill '${cols[1]}' -opaque gray50 -fuzz 15% ` +
          `-fill '${cols[2]}' -opaque gray20 -fill '${cols[3]}' -opaque black \\`
        );
        lines.push('#   out.png');

        // finalize and copy all lines
        const text = lines.join('\n');
        navigator.clipboard.writeText(text);
        showToast('Copied!');

        // Safari active-state workaround
        copyBtn.disabled = true; copyBtn.blur(); copyBtn.disabled = false;
      };
      box.append(copyBtn);
      // preview button for image mapping
      const previewBtn = document.createElement('button');
      previewBtn.className = 'palette-preview';
      // Feather 'image'
      previewBtn.innerHTML = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" stroke="currentColor" fill="none" stroke-width="2.5" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
      `;
      previewBtn.title = 'Preview image';
      previewBtn.onclick = () => {
        // Toggle this palette's preview
        const existing = box.querySelector('.preview-area');
        if (existing) {
          existing.classList.remove('show');
          setTimeout(() => existing.remove(), 300);
          return;
        }
        // Create preview area
        const area = document.createElement('div');
        area.className = 'preview-area';
        const cv = document.createElement('canvas');
        // Determine size with auto-scaling
        let w, h;
        if (imgBuffer && (imgBuffer.width || imgBuffer.naturalWidth)) {
          const bufW = imgBuffer.width || imgBuffer.naturalWidth;
          const bufH = imgBuffer.height || imgBuffer.naturalHeight;
          if (bufW > 500 || bufH > 500) {
            // downscale large images by 50%
            w = Math.round(bufW / 2);
            h = Math.round(bufH / 2);
          } else if (bufW < 200 || bufH < 200) {
            // upscale small images by 2x
            w = bufW * 2;
            h = bufH * 2;
          } else {
            // use native size
            w = bufW;
            h = bufH;
          }
        } else {
          // default placeholder size
          w = 160;
          h = 144;
        }
        cv.width = w;
        cv.height = h;
        cv.style.width = w + 'px';
        cv.style.height = h + 'px';
        cv.style.display = 'block';
        cv.style.margin = '10px auto';
        const ctx = cv.getContext('2d', { willReadFrequently: true });
        ctx.imageSmoothingEnabled = false;
        if (imgBuffer && (imgBuffer.src || imgBuffer.getContext)) {
          // Draw and remap
          ctx.drawImage(imgBuffer, 0, 0, w, h);
          const markers = box.querySelectorAll('.marker');
          remapCanvas(ctx, w, h, markers);
        } else {
          // Draw placeholder image
          const placeholderImg = document.getElementById('gb-placeholder');
          ctx.drawImage(placeholderImg, 0, 0, w, h);
        }
        cv.style.cursor = 'pointer';
        cv.onclick = () => globalFileInput.click();
        // tooltip for selecting new image
        cv.title = 'Click to select a new image';
        area.append(cv);
        box.append(area);
        requestAnimationFrame(() => area.classList.add('show'));

        // Safari active-state workaround
        previewBtn.disabled = true; previewBtn.blur(); previewBtn.disabled = false;
      };
      box.append(previewBtn);const line=document.createElement('div');line.className='visual-line-container';const l0 = document.createElement('div');
      l0.className = 'visual-line-label left';
      l0.innerHTML = '<i>L</i>*';
      line.append(l0);p.colors.forEach((hex,i)=>{const m=createMarkerSvg(hex,i);line.append(m);const dot=document.createElement('div');dot.style.width='12px';dot.style.height='12px';dot.style.borderRadius='50%';dot.style.position='absolute';dot.style.bottom='calc(50% - 6px)';dot.style.transform='translateX(-50%)';// Position original dot on reversed axis
      dot.style.left = (100 - m.__origL) + '%';dot.style.background=hex;dot.style.border='1px solid #888';dot.title = `Reset Color ${i}`; // revert to reset functionality
      dot.onclick = () => {
          // Reset this individual marker to its original color and position
          const origL = m.__origL;
          m.style.left = (100 - origL) + '%';
          // revert hex to original
          m.__hex = m.__origHex;
          const { a, b } = m.__labAB;
          const rgb = labToRgb(origL, a, b);
          const path = m.querySelector('.marker-path');
          if (path) path.setAttribute('fill', `rgb(${rgb.r},${rgb.g},${rgb.b})`);
          // update tooltip to reflect original values
          const titleElem = m.querySelector('title');
          if (titleElem) {
            const hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
            const Cval = Math.hypot(a, b).toFixed(1);
            const hDeg = Math.round((Math.atan2(b, a) * 180/Math.PI + 360) % 360);
            titleElem.textContent =
              `${m.__hex}
rgb(${rgb.r}, ${rgb.g}, ${rgb.b})
hsb(${hsv.h}¬∞, ${hsv.s}%, ${hsv.v}%)
L*C*h_ab(${origL.toFixed(1)}, ${Cval}, ${hDeg}¬∞)`;
          }
          // Refresh this preview only
          remapAllPreviews();
        };line.append(dot);});box.append(line);const d=document.createElement('div');d.className='palette-details';// palette title as a header with link and id for deep linking
      const nm = document.createElement('h2');
      nm.className = 'palette-name';
      // generate slug id from paletteName
      const slug = slugify(p.title);
      nm.id = slug;
      if (p.source) {
        const link = document.createElement('a');
        link.href = p.source;
        link.target = '_blank';
        link.textContent = p.title;
        nm.append(link);
      } else {
        nm.textContent = p.title;
      }
      d.append(nm);
      // author subheading
      if (p.origin) {
        const auth = document.createElement('div');
        auth.className = 'palette-author';
        auth.textContent = 'by ' + p.origin.trim();
        d.append(auth);
      }if (p.tags) {
        const tg = document.createElement('div');
        tg.className = 'palette-tags';
        // clickable tags
        p.tags.forEach(tRaw => {
          const tag = tRaw.toLowerCase();
          const display = tRaw.startsWith('@') ? tRaw : '#' + tag;
          const span = document.createElement('span');
          span.textContent = display;
          span.style.cursor = 'pointer';
          span.style.margin = '0 4px';
          span.onclick = () => {
            selectedTag = tag;
            const sel = document.getElementById('tag-filter');
            sel.value = tag;
            renderPalettes();
          };
          tg.append(span);
        });
        d.append(tg);
      }
      box.append(d);
      return box;}
    function renderPalettes() {
      // Read sort/filter values
      const primary = document.getElementById('primary-sort').value;
      const secondarySelect = document.getElementById('secondary-sort');
      let secondary = secondarySelect.value;
      const direction = document.getElementById('sort-direction').value;

      // Adjust secondary options
      if (primary === 'title') {
        secondarySelect.innerHTML = '<option value="">(none)</option>';
        secondarySelect.disabled = true;
        secondary = '';
      } else {
        secondarySelect.disabled = false;
        const prev = secondary;
        secondarySelect.innerHTML =
          '<option value="L">L*</option>' +
          '<option value="C">C*</option>' +
          '<option value="h">h*</option>';
        secondarySelect.value = ['L','C','h'].includes(prev) ? prev : 'L';
        secondary = secondarySelect.value;
      }

      // Load data
      let ps = JSON.parse(document.getElementById('palettes-data').textContent);

      // Sort palettes
      ps.sort((a, b) => {
        let cmp = 0;
        if (primary === 'title') {
          cmp = a.title.localeCompare(b.title);
        } else {
          const idx = parseInt(primary, 10);
          const rgbA = hexToRgb(a.colors[idx]);
          const rgbB = hexToRgb(b.colors[idx]);
          const [La, aA, bA] = xyzToLab(...rgbToXyz(rgbA.r, rgbA.g, rgbA.b));
          const [Lb, aB, bB] = xyzToLab(...rgbToXyz(rgbB.r, rgbB.g, rgbB.b));
          const metric = (L, aVal, bVal) => {
            if (secondary === 'C') return Math.hypot(aVal, bVal);
            if (secondary === 'h') return (Math.atan2(bVal, aVal) * 180/Math.PI + 360) % 360;
            return L;
          };
          cmp = metric(La, aA, bA) - metric(Lb, aB, bB);
        }
        return direction === 'desc' ? -cmp : cmp;
      });

      // Filter and render
      const container = document.getElementById('palette-container');
      container.innerHTML = '';
      ps.filter(p => selectedTag === 'all' || (p.tags && p.tags.map(t => t.toLowerCase()).includes(selectedTag)))
        .forEach(p => container.appendChild(renderPalette(p)));

      bindDrag();}
    function bindDrag() {
      // Use Pointer Events for cross-device dragging
      document.querySelectorAll('.marker').forEach(m => {
        m.style.touchAction = 'none'; // disable default gestures
        m.addEventListener('pointerdown', e => {
          e.preventDefault();
          const startX = e.clientX;
          const startCoord = parseFloat(m.style.left);
          const startL = 100 - startCoord;
          const rect = m.parentElement.getBoundingClientRect();
          const lv = document.createElement('div');
          lv.className = 'l-value';
          m.parentElement.append(lv);
          dragData = { m, startX, startL, rect, lv };
          m.setPointerCapture(e.pointerId);
          document.addEventListener('pointermove', doDrag);
          document.addEventListener('pointerup', endDrag, { once: true });
        });
      });
    }
function doDrag(e) {
      if (!dragData) return;
      e.preventDefault();
      const { m, startX, startL, rect, lv } = dragData;
      const dx = e.clientX - startX;
      const newL = Math.min(100, Math.max(0, startL - (dx / rect.width) * 100));
      // Position marker on reversed axis
      m.style.left = (100 - newL) + '%';
      // Recalculate color
      const { a, b } = m.__labAB;
      const rgb = labToRgb(newL, a, b);
      const newHex = rgbToHex(rgb.r, rgb.g, rgb.b);
      m.__hex = newHex;
      // Update marker fill
      const path = m.querySelector('.marker-path');
      if (path) path.setAttribute('fill', `rgb(${rgb.r},${rgb.g},${rgb.b})`);
      // Update live label
      lv.textContent = Math.round(newL) + '%';
      lv.style.left = (100 - newL) + '%';
      // Update tooltip
      const titleElem = m.querySelector('title');
      if (titleElem) {
        const hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
        const Cval = Math.hypot(a, b).toFixed(1);
        const hDeg = Math.round((Math.atan2(b, a) * 180/Math.PI + 360) % 360);
        titleElem.textContent =
          `${newHex}
rgb(${rgb.r}, ${rgb.g}, ${rgb.b})
hsb(${hsv.h}¬∞, ${hsv.s}%, ${hsv.v}%)
L*C*h_ab(${newL.toFixed(1)}, ${Cval}, ${hDeg}¬∞)`;
      }
      // Schedule live preview update// immediate fallback to ensure preview updates
      remapAllPreviews();
    }

    function endDrag(e) {
      // Remove live L* label
      if (dragData && dragData.lv) {
        dragData.lv.remove();
      }
      // Clean up event listeners for pointer drag
      document.removeEventListener('pointermove', doDrag);
      document.removeEventListener('pointerup', endDrag);
      // Release pointer capture if set
      if (dragData && dragData.m && e && e.pointerId) {
        dragData.m.releasePointerCapture(e.pointerId);
      }
      dragData = null;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Load additional palettes from palettes.json if available
      try {
        const resp = await fetch('palettes.json');
        if (resp.ok) {
          const extra = await resp.json();
          const core = JSON.parse(document.getElementById('palettes-data').textContent);
          // Deduplicate, preferring entries from palettes.json (extra) over core based on unique title and colors
          const seen = new Set();
          const merged = [];
          // helper to build a dedupe key ignoring tags/origin differences
          const makeKey = p => `${p.title.trim().toLowerCase()}|${p.colors.map(c=>c.toLowerCase()).join(',')}`;
          // Add extra first
          extra.forEach(p => {
            const key = makeKey(p);
            if (!seen.has(key)) {
              seen.add(key);
              merged.push(p);
            } else {
              console.warn('Duplicate palette in palettes.json (ignored):', p.title);
            }
          });
          // Add core entries not present in extra
          core.forEach(p => {
            const key = makeKey(p);
            if (!seen.has(key)) {
              merged.push(p);
            } else {
              console.info('Duplicate palette dropped in favor of palettes.json:', p.title);
            }
          });
          document.getElementById('palettes-data').textContent = JSON.stringify(merged);
        }

      } catch (e) {
        console.warn('Could not load palettes.json, using built-in only.', e);
      }
      // Treat placeholder as the initial image buffer so previews and resets work
      const placeholderImg = document.getElementById('gb-placeholder');
      imgBuffer = placeholderImg;
      imgSelected.src = placeholderImg.src;

      // Global image selector for all palette previews
      globalFileInput = document.createElement('input');
      globalFileInput.type = 'file';
      globalFileInput.accept = 'image/*';
      globalFileInput.style.display = 'none';

      globalFileInput.onchange = () => {
        const file = globalFileInput.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        imgSelected.onload = () => {
          // update buffer to loaded image
          imgBuffer = imgSelected;
          // resize existing preview canvases to match new image dimensions
          document.querySelectorAll('.preview-area canvas').forEach(cv => {
            const bufW = imgBuffer.width || imgBuffer.naturalWidth;
            const bufH = imgBuffer.height || imgBuffer.naturalHeight;
            let w, h;
            if (bufW > 500 || bufH > 500) {
              w = Math.round(bufW / 2);
              h = Math.round(bufH / 2);
            } else if (bufW < 200 || bufH < 200) {
              w = bufW * 2;
              h = bufH * 2;
            } else {
              w = bufW;
              h = bufH;
            }
            cv.width = w;
            cv.height = h;
            cv.style.width = w + 'px';
            cv.style.height = h + 'px';
          });
          // redraw all open previews with the new image
          remapAllPreviews();
          URL.revokeObjectURL(url);
        };
        imgSelected.src = url;
      };
      document.body.append(globalFileInput);

      // listen for system theme changes
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      mq.addEventListener('change', () => {
        if (modes[mi] === 'system') applyTheme();
      });
      renderTagFilter();
      ['primary-sort','secondary-sort','sort-direction'].forEach(id =>
        document.getElementById(id).addEventListener('change', renderPalettes)
      );
      // Chroma toggle: apply CSS class for grayscale
      const chromaToggle = document.getElementById('chroma-toggle');
      // initialize toggle state and icon
      const isNoInitial = document.body.classList.contains('no-chroma');
      chromaToggle.textContent = isNoInitial ? 'üé®' : 'ü©∂';
      chromaToggle.title = isNoInitial ? 'Display with color' : 'Display as grayscale';
      chromaToggle.onclick = () => {
        const isNo = document.body.classList.toggle('no-chroma');
        chromaToggle.textContent = isNo ? 'üé®' : 'ü©∂';
        chromaToggle.title = isNo ? 'Display with color' : 'Display as grayscale';
      };
      renderPalettes();
    });
  </script>
  <script type="application/json" id="palettes-data">
  [
    {"title":"Velvet Cherry GB","origin":"Klafooty","source":"https://lospec.com/palette-list/velvet-cherry-gb","colors": ["#9775a6","#683a68","#412752","#2d162c"],"tags":["Lospec","üíú"]},
    {"title":"Fiery Plague GB","origin":"Klafooty","source":"https://lospec.com/palette-list/fiery-plague-gb","colors":["#713141","#512839","#312137","#1a2129"],"tags":["Lospec","Dark","‚ù§Ô∏è","üíú"]},
    {"title":"Moon Crystal","origin":"Doph","source":"https://lospec.com/palette-list/moon-crystal","colors": ["#ffe2db","#d9a7c6","#8d89c7","#755f9c"],"tags":["Lospec","Pastel", "üíú","ü©∑"]},
    {"title":"Optimized Grayscale 4","origin":"Yousurname","source":"https://lospec.com/palette-list/optimized-grayscale-4","colors": ["#dfdfdf","#9f9f9f","#606060","#202020"],"tags":["Lospec","Lo-Chroma","ü©∂"]},
    {"title":"Absorbent and Yellow","origin":"TheWolfBunny64","source":"https://thewolfbunny64.itch.io/game-boy-custom-palettes","colors": ["#fff752","#aec600","#687600","#343b00"],"tags":["@TheWolfBunny64","Am-Pop-Culture","DMG","üíö"]},
    {"title":"Barbie Pink","origin":"TheWolfBunny64","source":"https://thewolfbunny64.itch.io/game-boy-custom-palettes","colors": ["#f200a1","#c10080","#790050","#480030"],"tags":["@TheWolfBunny64","Am-Pop-Culture","ü©∑"]},
    {"title":"Bedrock Caveman Vision","origin":"TheWolfBunny64","source":"https://thewolfbunny64.itch.io/game-boy-custom-palettes","colors": ["#ff7f00","#009eb8","#005e6e","#002f37"],"tags":["@TheWolfBunny64","Am-Pop-Culture","üåà"]}
    ]
  </script>
</body>
</html>
